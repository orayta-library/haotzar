name: Build Otzaria Index

# ×–×¨×™×ž×” ×œ×‘× ×™×™×ª ××™× ×“×§×¡ Meilisearch ×ž×¡×¤×¨×™ ××•×¦×¨×™×
# ×ž×•×¨×™×“×” ××ª seforim.db, ×‘×•× ×” ××™× ×“×§×¡ ×•×ž×¢×œ×” ×›-artifact
# 
# ×”×¤×¢×œ×”:
# 1. ×™×“× ×™×ª: Actions â†’ Build Otzaria Index â†’ Run workflow
# 2. ××•×˜×•×ž×˜×™×ª: ×›×œ ×™×•× ×¨××©×•×Ÿ ×‘×—×¦×•×ª
#
# ×ª×•×¦××•×ª:
# - otzaria-index.tar.gz - ××™× ×“×§×¡ ×ž×•×›×Ÿ ×œ×©×™×ž×•×©
# - otzaria-index-info.txt - ×ž×™×“×¢ ×¢×œ ×”×‘× ×™×”

on:
  workflow_dispatch: # ×¨×™×¦×” ×™×“× ×™×ª
  schedule:
    - cron: '0 0 * * 0' # ×›×œ ×™×•× ×¨××©×•×Ÿ ×‘×—×¦×•×ª (×¢×“×›×•×Ÿ ×©×‘×•×¢×™)

jobs:
  build-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install better-sqlite3
          npm install minimist
      
      - name: Create books directory
        run: mkdir -p books/××•×¦×¨×™×
      
      - name: Download Otzaria database
        run: |
          echo "ðŸ“¥ Downloading seforim.zip..."
          curl -L -o seforim.zip https://github.com/Otzaria/otzaria-library/releases/download/library-db-1/seforim.zip
          
          echo "ðŸ“¦ Extracting seforim.db..."
          unzip -q seforim.zip -d books/××•×¦×¨×™×/
          
          echo "âœ… Database downloaded and extracted"
          ls -lh books/××•×¦×¨×™×/
      
      - name: Build Otzaria index
        run: |
          echo "ðŸš€ Building Otzaria index..."
          node --expose-gc scripts/build-otzaria-index.js
      
      - name: Verify index was created
        run: |
          echo "ðŸ” Verifying index files..."
          
          if [ ! -f "index-otzaria/meili-docs.json" ]; then
            echo "âŒ meili-docs.json not found!"
            exit 1
          fi
          
          if [ ! -f "index-otzaria/posmap.sqlite" ]; then
            echo "âŒ posmap.sqlite not found!"
            exit 1
          fi
          
          echo "âœ… Index files verified"
          
          # ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª
          echo ""
          echo "ðŸ“Š Index Statistics:"
          echo "==================="
          wc -l index-otzaria/meili-docs.json | awk '{print "Documents: " $1}'
          du -h index-otzaria/meili-docs.json | awk '{print "JSON Size: " $1}'
          du -h index-otzaria/posmap.sqlite | awk '{print "SQLite Size: " $1}'
      
      - name: Create index archive
        run: |
          echo "ðŸ“¦ Creating index archive..."
          cd index-otzaria
          tar -czf ../otzaria-index.tar.gz .
          cd ..
          
          echo "âœ… Archive created"
          ls -lh otzaria-index.tar.gz
      
      - name: Upload index as artifact
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-index
          path: otzaria-index.tar.gz
          retention-days: 90
      
      - name: Generate index info
        run: |
          echo "ðŸ“Š Index Information" > index-info.txt
          echo "===================" >> index-info.txt
          echo "" >> index-info.txt
          echo "Build Date: $(date)" >> index-info.txt
          echo "Build Commit: ${{ github.sha }}" >> index-info.txt
          echo "" >> index-info.txt
          echo "Files:" >> index-info.txt
          ls -lh index-otzaria/ >> index-info.txt
          echo "" >> index-info.txt
          echo "Archive Size:" >> index-info.txt
          ls -lh otzaria-index.tar.gz >> index-info.txt
          
          cat index-info.txt
      
      - name: Upload index info
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-index-info
          path: index-info.txt
          retention-days: 90
