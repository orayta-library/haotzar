name: Build Otzaria Index

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install better-sqlite3
          npm install minimist

      - name: Create books directory
        run: mkdir -p books/××•×¦×¨×™×

      - name: Download Otzaria database
        run: |
          echo "ðŸ“¥ Downloading seforim.db.zip..."
          curl -L -f -o seforim.zip \
            --max-time 300 \
            --retry 3 \
            --retry-delay 5 \
            https://github.com/Otzaria/otzaria-library/releases/download/library-db-1/seforim.db.zip
          
          # Verify the download
          if [ ! -f seforim.zip ]; then
            echo "âŒ Download failed: seforim.zip not found"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z seforim.zip 2>/dev/null || stat -c%s seforim.zip 2>/dev/null)
          echo "âœ… Downloaded seforim.zip (Size: $FILE_SIZE bytes)"
          
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "âŒ File too small ($FILE_SIZE bytes), likely incomplete download"
            exit 1
          fi
          
          echo "ðŸ“¦ Extracting seforim.db..."
          unzip -q seforim.zip -d books/××•×¦×¨×™×/
          echo "âœ… Database extracted"
          ls -lh books/××•×¦×¨×™×/

      - name: Build Otzaria index
        run: |
          echo "ðŸš€ Building Otzaria index..."
          node --expose-gc scripts/build-otzaria-index.js

      - name: Verify index was created
        run: |
          echo "ðŸ” Verifying index files..."
          if [ ! -f "index-otzaria/meili-docs.json" ]; then
            echo "âŒ meili-docs.json not found!"
            exit 1
          fi
          if [ ! -f "index-otzaria/posmap.sqlite" ]; then
            echo "âŒ posmap.sqlite not found!"
            exit 1
          fi
          echo "âœ… Index files verified"
          
          echo ""
          echo "ðŸ“Š Index Statistics:"
          echo "==================="
          wc -l index-otzaria/meili-docs.json | awk '{print "Documents: " $1}'
          du -h index-otzaria/meili-docs.json | awk '{print "JSON Size: " $1}'
          du -h index-otzaria/posmap.sqlite | awk '{print "SQLite Size: " $1}'

      - name: Create index archive
        run: |
          echo "ðŸ“¦ Creating index archive..."
          cd index-otzaria
          tar -czf ../otzaria-index.tar.gz .
          cd ..
          echo "âœ… Archive created"
          ls -lh otzaria-index.tar.gz

      - name: Upload index as artifact
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-index
          path: otzaria-index.tar.gz
          retention-days: 90

      - name: Generate index info
        run: |
          echo "ðŸ“Š Index Information" > index-info.txt
          echo "===================" >> index-info.txt
          echo "" >> index-info.txt
          echo "Build Date: $(date)" >> index-info.txt
          echo "Build Commit: ${{ github.sha }}" >> index-info.txt
          echo "" >> index-info.txt
          echo "Files:" >> index-info.txt
          ls -lh index-otzaria/ >> index-info.txt
          echo "" >> index-info.txt
          echo "Archive Size:" >> index-info.txt
          ls -lh otzaria-index.tar.gz >> index-info.txt
          cat index-info.txt

      - name: Upload index info
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-index-info
          path: index-info.txt
          retention-days: 90
