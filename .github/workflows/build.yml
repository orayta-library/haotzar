name: Build and Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

permissions:
  contents: write

jobs:
  build-electron-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Create required directories and download Meilisearch
      run: |
        # Create directories if they don't exist
        if (-not (Test-Path "books")) { New-Item -ItemType Directory -Path "books" }
        if (-not (Test-Path "resources/meilisearch")) { New-Item -ItemType Directory -Path "resources/meilisearch" -Force }
        "Placeholder for books directory" | Out-File -FilePath "books/README.txt"
        
        # Download Meilisearch directly
        $version = "v1.5.1"
        $url = "https://github.com/meilisearch/meilisearch/releases/download/$version/meilisearch-windows-amd64.exe"
        $output = "resources/meilisearch/meilisearch.exe"
        
        Write-Host "Downloading Meilisearch $version..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Meilisearch downloaded successfully"
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Build Electron app
      run: npm run electron:build:win

    - name: Upload Electron artifacts (non-release)
      uses: actions/upload-artifact@v4
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: electron-windows-installer
        path: |
          release/*.exe
          release/*.msi

    - name: Create Release (for tags)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/*.exe
        draft: true
        prerelease: false
        name: 'האויצר v${{ github.ref_name }}'
        body: |
          ## האויצר - אפליקציית ספרייה תורנית
          
          ### הורדה והתקנה:
          1. הורד את קובץ ההתקנה (Setup.exe)
          2. הפעל את הקובץ ועקוב אחר ההוראות
          
          ### דרישות מערכת:
          - Windows 10/11 (64-bit)
          - 4GB RAM מומלץ
          - 100GB שטח פנוי (לספרים)
          
          ### תכונות:
          - חיפוש מהיר עם Meilisearch
          - תמיכה בקבצי PDF ו-TXT
          - ממשק בעברית
          - תמיכה בתיקיות חיצוניות
          
          ### שינויים בגרסה זו:
          - ראה את רשימת השינויים המלאה בדף הפרויקט
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-tauri-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Create required directories and download Meilisearch
      run: |
        # Create directories if they don't exist
        if (-not (Test-Path "books")) { New-Item -ItemType Directory -Path "books" }
        if (-not (Test-Path "resources/meilisearch")) { New-Item -ItemType Directory -Path "resources/meilisearch" -Force }
        "Placeholder for books directory" | Out-File -FilePath "books/README.txt"
        
        # Download Meilisearch directly
        $version = "v1.5.1"
        $url = "https://github.com/meilisearch/meilisearch/releases/download/$version/meilisearch-windows-amd64.exe"
        $output = "resources/meilisearch/meilisearch.exe"
        
        Write-Host "Downloading Meilisearch $version..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Meilisearch downloaded successfully"
      shell: pwsh

    - name: Install dependencies
      run: npm install

    - name: Create placeholder icons if needed
      run: |
        if (-not (Test-Path "src-tauri/icons/icon.ico")) {
          Write-Host "Creating placeholder Tauri icons..."
          
          New-Item -ItemType Directory -Force -Path "src-tauri/icons" | Out-Null
          
          if (Test-Path "public/home-background.png") {
            Copy-Item "public/home-background.png" "temp-icon.png"
            
            try {
              npm run tauri icon temp-icon.png 2>&1 | Out-Null
              Remove-Item "temp-icon.png" -ErrorAction SilentlyContinue
              Write-Host "✅ Icons generated"
            } catch {
              Write-Host "⚠️ Could not generate icons: $_"
            }
          }
        } else {
          Write-Host "✅ Icons already exist"
        }
      shell: pwsh
      continue-on-error: false

    - name: Build Tauri app
      run: npm run tauri:build

    - name: Upload Tauri artifacts (non-release)
      uses: actions/upload-artifact@v4
      if: "!startsWith(github.ref, 'refs/tags/')"
      with:
        name: tauri-windows-installer
        path: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe

    - name: Create Tauri Release (for tags)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe
        draft: true
        prerelease: false
        name: 'האויצר (Tauri) v${{ github.ref_name }}'
        body: |
          ## האויצר - אפליקציית ספרייה תורנית (Tauri)
          
          ### הורדה והתקנה:
          1. הורד את קובץ ההתקנה (.exe או .msi)
          2. הפעל את הקובץ ועקוב אחר ההוראות
          
          ### יתרונות גרסת Tauri:
          - גודל קובץ קטן משמעותית (~10MB במקום ~100MB)
          - צריכת זיכרון נמוכה יותר
          - ביצועים משופרים
          - אבטחה מוגברת
          
          ### דרישות מערכת:
          - Windows 10/11 (64-bit)
          - 2GB RAM מומלץ
          - 100GB שטח פנוי (לספרים)
          
          ### תכונות:
          - חיפוש מהיר עם Meilisearch
          - תמיכה בקבצי PDF ו-TXT
          - ממשק בעברית
          - תמיכה בתיקיות חיצוניות
          
          ### שינויים בגרסה זו:
          - ראה את רשימת השינויים המלאה בדף הפרויקט
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run linter
      run: npm run lint --if-present

    - name: Run tests
      run: npm test --if-present