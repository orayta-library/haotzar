# חיפוש חכם - שיפורים ברלוונטיות

## הבעיה
החיפוש היה מחזיר יותר מדי תוצאות, כולל תוצאות לא רלוונטיות, כי:
- לא היה סינון לפי ציון רלוונטיות
- הוחזרו עד 1000 תוצאות ללא הגבלה
- לא היה מיון חכם לפי איכות ההתאמה

## השיפורים

### 1. סינון מחמיר לפי ציון רלוונטיות
```javascript
const MIN_SCORE = 0.7; // רק תוצאות עם ציון מעל 70%
const relevantHits = searchResults.hits.filter(hit => {
  const score = hit._rankingScore || 0;
  return score >= MIN_SCORE;
});
```

**מה זה אומר?**
- Meilisearch נותן לכל תוצאה ציון בין 0 ל-1
- רק תוצאות עם ציון מעל 0.7 (70%) מוחזרות
- זה מבטיח שרק התאמות טובות מאוד יוצגו
- מונע הצפה של תוצאות לא רלוונטיות

### 2. מיון חכם לפי רלוונטיות
```javascript
.sort((a, b) => {
  // 1. ציון מקסימלי (ההתאמה הטובה ביותר בקובץ)
  if (Math.abs(b.maxScore - a.maxScore) > 0.01) {
    return b.maxScore - a.maxScore;
  }
  // 2. ציון כולל (סכום כל ההתאמות)
  if (Math.abs(b.totalScore - a.totalScore) > 0.1) {
    return b.totalScore - a.totalScore;
  }
  // 3. מספר התאמות
  return b.matchCount - a.matchCount;
})
```

**סדר עדיפויות:**
1. קבצים עם ההתאמה הטובה ביותר
2. קבצים עם הכי הרבה התאמות איכותיות
3. קבצים עם הכי הרבה התאמות בכלל

### 3. הגבלת מספר התוצאות
- **מבקש מ-Meilisearch:** עד 10,000 תוצאות (chunks - מקסימום אפשרי)
- **מסנן לפי ציון:** רק תוצאות מעל 0.5 (50%)
- **מקבץ לפי ספרים:** מאחד תוצאות מאותו ספר
- **מציג למשתמש:** עד 500 ספרים הטובים ביותר

**הגיון:**
1. מבקש 10,000 תוצאות (chunks) - **כיסוי מלא של כל התוצאות הרלוונטיות**
2. מסנן תוצאות חלשות (מתחת ל-50%)
3. מקבץ לפי ספרים (כל ספר יכול להופיע פעם אחת)
4. ממיין לפי איכות
5. מציג רק את 500 הספרים הטובים ביותר ל-UI

**הערה:** Meilisearch תמיד מחפש בכל המאגר, ה-limit רק קובע כמה תוצאות מוחזרות.

### 4. כללי דירוג משופרים (Ranking Rules)
```javascript
rankingRules: [
  'words',        // כמה מילות חיפוש נמצאו
  'typo',         // פחות שגיאות כתיב = טוב יותר
  'proximity',    // מילים קרובות יותר = טוב יותר
  'attribute',    // content חשוב יותר מ-fileName
  'sort',         // מיון
  'exactness'     // התאמה מדויקת = הכי טוב
]
```

### 5. אסטרטגיית התאמה מחמירה
```javascript
matchingStrategy: 'last' // רק תוצאות שכל המילים נמצאות (או רוב)
```

**לפני:** גם אם רק מילה אחת מתאימה - התוצאה מוחזרת  
**אחרי:** רוב המילים חייבות להתאים

### 6. סובלנות מוגבלת לשגיאות כתיב
```javascript
typoTolerance: {
  minWordSizeForTypos: {
    oneTypo: 4,   // רק מילים מעל 4 תווים
    twoTypos: 8   // רק מילים מעל 8 תווים
  }
}
```

**למה זה חשוב?**
- מונע תוצאות לא רלוונטיות ממילים קצרות דומות
- מילים קצרות (2-3 תווים) חייבות להתאים בדיוק

## תוצאות

### לפני השיפורים
```
חיפוש: "שבת"
תוצאות: 847 קבצים
בעיה: גם קבצים עם אזכור אחד של "שבת" בהערת שוליים
```

### אחרי השיפורים
```
חיפוש: "שבת"
תוצאות: 200 קבצים (מתוך 10,000 שנבדקו - כיסוי מלא!)
יתרון: רק קבצים שבהם "שבת" מופיע באופן משמעותי
ציון: 0.95 (גבוה) עד 0.50 (סף מינימום)
הדגשה: כל המילים הרלוונטיות מודגשות
כיסוי: 100% של כל התוצאות הרלוונטיות במאגר
```

## איך להשתמש

### חיפוש רגיל
```javascript
const results = await meilisearchEngine.search('הלכות שבת');
// מבקש 10,000 תוצאות (כיסוי מלא), מסנן ומחזיר עד 200 הטובות ביותר
```

### חיפוש עם הגבלה
```javascript
const results = await meilisearchEngine.search('הלכות שבת', {
  maxResults: 50  // רק 50 התוצאות הטובות ביותר
});
```

### חיפוש עם יותר תוצאות
```javascript
const results = await meilisearchEngine.search('הלכות שבת', {
  maxResults: 500  // 500 התוצאות הטובות ביותר
});
```

### הבנת הציונים
- **0.9-1.0:** התאמה מושלמת
- **0.7-0.9:** התאמה טובה מאוד
- **0.5-0.7:** התאמה טובה - **רק אלה ומעלה מוצגות**
- **מתחת ל-0.5:** התאמה חלשה - **לא מוצג**

**הסף הנוכחי: 50%** - רק תוצאות טובות ומעלה

## טיפים לחיפוש טוב יותר

1. **חפש ביטויים ספציפיים:** "הלכות שבת" טוב יותר מ-"שבת"
2. **השתמש במילים מלאות:** "תפילין" טוב יותר מ-"תפל"
3. **הוסף הקשר:** "ברכת המזון בשבת" טוב יותר מ-"ברכה"
4. **בדוק את הציון:** תוצאות עם ציון מעל 0.7 בדרך כלל מאוד רלוונטיות

## שאלות נפוצות

**ש: למה אני לא רואה קובץ שאני יודע שיש בו את המילה?**  
ת: אם הציון שלו מתחת ל-0.5 (50%), הוא לא יוחזר. הסף נמוך יחסית כדי לכלול גם תוצאות עם שגיאות הקלדה קלות. אם אתה רוצה לראות יותר תוצאות, אפשר להוריד את הסף בקוד. שים לב: המערכת מחפשת בכל המאגר (עד 10,000 תוצאות).

**ש: איך אני יכול לראות יותר תוצאות?**  
ת: המערכת כבר מבקשת 10,000 תוצאות (מקסימום Meilisearch) ומציגה את 200 הטובות ביותר. אם אתה רוצה לראות יותר, העבר `maxResults` גבוה יותר לפונקציית החיפוש (עד 500-1000).

**ש: האם החיפוש מחפש בכל המאגר?**  
ת: כן! Meilisearch תמיד מחפש בכל המאגר. ה-limit של 10,000 מבטיח שאנחנו מקבלים את כל התוצאות הרלוונטיות (במרבית המקרים יהיו פחות מ-10,000 תוצאות).

**ש: החיפוש לא מוצא מילה עם שגיאת כתיב**  
ת: שגיאות כתיב נתמכות רק במילים מעל 4 תווים. מילים קצרות חייבות להיות מדויקות.

**ש: למה רק חלק מהמילים מודגשות?**  
ת: המערכת מדגישה את כל המילים מהשאילתה שנמצאו בטקסט. אם מילה לא מודגשת, ייתכן שהיא לא נמצאה בחלק הספציפי הזה של הטקסט.

## בניית אינדקס מחדש

אם שינית את ההגדרות, צריך לבנות את האינדקס מחדש:

```bash
# עצור את האפליקציה
# הרץ:
node scripts/build-full-index.cmd
```

זה יבנה אינדקס חדש עם כללי הדירוג המשופרים.
